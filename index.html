<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lanort - Sistema de Pedidos</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:white;min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto}.header{text-align:center;margin-bottom:30px;padding:20px 0}.logo{max-width:200px;height:auto;margin:0 auto}.logo img{width:100%;height:auto}.cart-floating{position:fixed;top:20px;right:20px;z-index:1000}.cart-badge{background:#ff5722;color:white;border:none;border-radius:50%;width:60px;height:60px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(255,87,34,0.3);transition:all 0.3s;position:relative}.cart-badge:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(255,87,34,0.4)}.cart-icon{font-size:1.5rem;margin-bottom:2px}.cart-count{font-size:0.9rem;font-weight:bold}.cart-badge.empty{background:#ccc;box-shadow:0 4px 15px rgba(0,0,0,0.1)}.cart-badge.empty:hover{background:#bbb;box-shadow:0 6px 20px rgba(0,0,0,0.2)}.page-title{text-align:center;color:#e65100;margin-bottom:10px;font-size:1.5rem;font-weight:600}.search-container{background:#fff5f0;padding:30px;border-radius:15px;box-shadow:0 5px 15px rgba(255,87,34,0.1);margin-bottom:30px;border:2px solid #ffe0d0}.search-main{display:grid;grid-template-columns:2fr 1fr;gap:25px;margin-bottom:25px}@media (max-width:768px){.search-main{grid-template-columns:1fr}.cart-floating{top:10px;right:10px}.cart-badge{width:50px;height:50px}.cart-icon{font-size:1.3rem}.cart-count{font-size:0.8rem}}.search-free{display:flex;flex-direction:column}.search-free label{font-weight:600;margin-bottom:10px;color:#e65100;font-size:1.1rem}.search-free input{padding:15px;border:2px solid #ffb74d;border-radius:8px;font-size:16px;transition:border-color 0.3s;background:white}.search-free input:focus{outline:none;border-color:#ff5722;box-shadow:0 0 0 3px rgba(255,87,34,0.1)}.brands-filter{display:flex;flex-direction:column}.brands-filter label{font-weight:600;margin-bottom:10px;color:#e65100;font-size:1.1rem}.brands-select{padding:15px;border:2px solid #ffb74d;border-radius:8px;font-size:16px;background:white;cursor:pointer;transition:border-color 0.3s}.brands-select:focus{outline:none;border-color:#ff5722;box-shadow:0 0 0 3px rgba(255,87,34,0.1)}.search-actions{display:flex;gap:15px;justify-content:space-between;align-items:center}.btn{padding:15px 30px;background:linear-gradient(135deg,#ff5722 0%,#e65100 100%);color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s}.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,87,34,0.3)}.btn:active{transform:translateY(0)}.btn-secondary{background:linear-gradient(135deg,#ffb74d 0%,#ff9800 100%)}.btn-success{background:linear-gradient(135deg,#4CAF50 0%,#388E3C 100%)}.btn:disabled{background:linear-gradient(135deg,#cccccc 0%,#999999 100%)!important;color:#666666!important;cursor:not-allowed!important;transform:none!important;box-shadow:none!important}.btn:disabled:hover{transform:none!important;box-shadow:none!important}.btn-loading{position:relative;color:transparent!important}.btn-loading::after{content:"";position:absolute;width:20px;height:20px;top:50%;left:50%;margin-left:-10px;margin-top:-10px;border:2px solid #ffffff;border-radius:50%;border-top-color:transparent;animation:spin 1s ease-in-out infinite}.btn-success:disabled{background:linear-gradient(135deg,#81C784 0%,#66BB6A 100%)!important}.results-container{background:white;border-radius:15px;box-shadow:0 5px 15px rgba(255,87,34,0.1);overflow:hidden;border:2px solid #ffe0d0}.results-header{padding:20px;background:#fff5f0;border-bottom:2px solid #ffccbc;display:flex;justify-content:space-between;align-items:center}.results-count{font-size:1.1rem;font-weight:600;color:#e65100}.loading{text-align:center;padding:40px;color:#ff9800}.loading-spinner{border:4px solid #ffe0b2;border-top:4px solid #ff5722;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:25px;padding:25px}@media (max-width:768px){.products-grid{grid-template-columns:1fr;gap:15px;padding:15px}}.product-card{border:2px solid #ffe0d0;border-radius:12px;overflow:hidden;transition:transform 0.3s,box-shadow 0.3s;background:white;display:flex;flex-direction:column}@media (max-width:768px){.product-card{border:1px solid #ffe0d0;margin-bottom:10px}.product-card:hover{transform:none;box-shadow:none}}.product-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(255,87,34,0.15);border-color:#ffb74d}.product-image-container{width:100%;height:200px;background:#fff5f0;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}@media (max-width:768px){.product-image-container{height:150px}}.product-image{max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;transition:transform 0.3s}.product-card:hover .product-image{transform:scale(1.05)}.no-image{color:#ff9800;font-size:14px;text-align:center;padding:20px}.product-info{padding:20px;flex-grow:1;display:flex;flex-direction:column}.product-code{font-size:0.9rem;color:#ff9800;margin-bottom:5px}.product-barcode{font-size:0.8rem;color:#ffb74d;margin-bottom:5px;font-family:monospace}.product-stock{font-size:0.8rem;color:#1976d2;margin-bottom:10px;font-weight:600}.product-brand{color:#ff5722;font-weight:600;margin-bottom:10px;padding:4px 8px;background:#ffe0d0;border-radius:4px;display:inline-block;align-self:flex-start}.product-description{font-size:1rem;font-weight:600;color:#e65100;margin-bottom:15px;line-height:1.4;flex-grow:1}.product-price{font-size:1.3rem;font-weight:700;color:#388e3c;margin-bottom:15px;text-align:center}.quantity-controls{display:flex;align-items:center;justify-content:center;gap:15px;margin-bottom:15px}.quantity-btn{width:40px;height:40px;border:2px solid #ff5722;background:white;color:#ff5722;border-radius:8px;font-size:1.2rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}.quantity-btn:hover{background:#ff5722;color:white}.quantity-input{width:80px;text-align:center;padding:10px;border:2px solid #ffb74d;border-radius:8px;font-size:1.1rem;font-weight:600}.add-to-cart{width:100%;padding:15px;background:linear-gradient(135deg,#4CAF50 0%,#388E3C 100%);color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s}.add-to-cart:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(76,175,80,0.3)}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:15px;width:90%;max-width:700px;max-height:80vh;overflow-y:auto}@media (max-width:768px){.modal-content{width:95%;max-height:90vh;padding:20px}}.cart-items{max-height:400px;overflow-y:auto;margin:20px 0}.cart-item{display:flex;align-items:flex-start;padding:15px;border-bottom:1px solid #eee;gap:15px}.cart-item-image-container{width:80px;height:80px;background:#fff5f0;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;border:1px solid #ffe0d0}.cart-item-image{max-width:100%;max-height:100%;object-fit:contain}.cart-item-no-image{color:#ff9800;font-size:24px}.cart-item-content{flex:1;min-width:0;display:flex;flex-direction:column;gap:8px}.cart-item-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}.cart-item-info{flex:1}.cart-item-description{font-weight:600;margin-bottom:4px;font-size:0.95rem;line-height:1.3}.cart-item-details{font-size:0.8rem;color:#666;margin-bottom:6px}.cart-item-price{font-size:0.9rem;color:#388e3c;font-weight:600}.cart-item-controls{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}.cart-quantity-controls{display:flex;align-items:center;gap:8px}.cart-quantity-btn{width:32px;height:32px;border:1px solid #ff5722;background:white;color:#ff5722;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}.cart-quantity-btn:hover{background:#ff5722;color:white}.cart-quantity-input{width:50px;text-align:center;padding:6px;border:1px solid #ffb74d;border-radius:6px;font-size:0.9rem;font-weight:600}.cart-item-total-section{display:flex;flex-direction:column;align-items:flex-end;gap:5px}.cart-item-total{font-weight:700;color:#388e3c;font-size:1rem}.item-subtotal{font-size:0.8rem;color:#666}.remove-item{background:#ff5252;color:white;border:none;border-radius:5px;padding:6px 10px;cursor:pointer;font-size:0.8rem;transition:all 0.2s;white-space:nowrap}.remove-item:hover{background:#d32f2f;transform:scale(1.05)}.cart-summary{background:#fff3e0;padding:20px;border-radius:10px;margin-top:20px}.cart-total{font-size:1.4rem;font-weight:700;color:#e65100;text-align:center;margin-bottom:15px}.client-form{background:#f8f9fa;padding:20px;border-radius:10px;margin-top:20px}.form-group{margin-bottom:15px}.form-group label{display:block;font-weight:600;margin-bottom:5px;color:#e65100}.form-group.required label::after{content:" *";color:#ff5252}.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #ffb74d;border-radius:8px;font-size:16px;transition:border-color 0.3s}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#ff5722;box-shadow:0 0 0 3px rgba(255,87,34,0.1)}.form-group input.error,.form-group select.error{border-color:#ff5252;background-color:#ffebee}.error-message{background:#ffebee;color:#c62828;padding:15px;border-radius:8px;margin:20px;text-align:center;border:1px solid #ffcdd2}.success-message{background:#e8f5e8;color:#2e7d32;padding:15px;border-radius:8px;margin:20px;text-align:center;border:1px solid #c8e6c9}.empty-state{text-align:center;padding:40px;color:#ff9800;grid-column:1/-1}.filters-summary{background:#fff3e0;padding:15px 25px;margin:0;border-radius:0;font-size:0.9rem;border-bottom:2px solid #ffccbc;color:#e65100}.selected-brand{display:inline-flex;align-items:center;gap:8px;background:#ff5722;color:white;padding:8px 15px;border-radius:20px;font-size:0.9rem;margin-top:8px}.selected-brand button{background:none;border:none;color:white;cursor:pointer;font-size:1.2rem;padding:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%}.selected-brand button:hover{background:rgba(255,255,255,0.2)}.real-time-total{background:#e8f5e8;padding:10px;border-radius:8px;text-align:center;margin-top:10px;font-weight:600;color:#2e7d32}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}.cart-badge.pulse{animation:pulse 0.5s ease-in-out}.field-error{color:#ff5252;font-size:0.8rem;margin-top:5px;display:none}.load-more-container{grid-column:1/-1;text-align:center;padding:20px}.mobile-loading{text-align:center;padding:30px;color:#ff9800}
    </style>
</head>
<body>
    <div class="cart-floating">
        <div id="cartBadge" class="cart-badge empty" onclick="openCartModal()">
            <div class="cart-icon">üõí</div>
            <div class="cart-count">0</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="https://storage.googleapis.com/lanort.prd.imagefiles.dynamicssales.com.br/ecommerce/logo.png?p=full" alt="Lanort Logo">
            </div>
            <div class="page-title"></div>
        </div>

        <div class="search-container">
            <div class="search-main">
                <div class="search-free">
                    <label for="freeSearch">Pesquisar:</label>
                    <input type="text" id="freeSearch" placeholder="Digite c√≥digo, marca, descri√ß√£o ou c√≥digo de barras...">
                </div>
                
                <div class="brands-filter">
                    <label for="brandsSelect">Filtrar por Marca:</label>
                    <select id="brandsSelect" class="brands-select">
                        <option value="">Todas as marcas</option>
                        <option value="loading" disabled>Carregando marcas...</option>
                    </select>
                </div>
            </div>

            <div class="search-actions">
                <button type="button" class="btn" onclick="searchProducts()">
                    üîç Buscar Produtos
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearSearch()">
                    üóëÔ∏è Limpar Tudo
                </button>
            </div>
        </div>

        <div class="results-container">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Use os filtros acima para buscar produtos</div>
            </div>

            <div id="filtersSummary" class="filters-summary" style="display: none;"></div>

            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Buscando produtos...</p>
            </div>

            <div id="results" class="products-grid">
                <div class="empty-state">
                    <div>üì¶</div>
                    <p>Use os filtros acima para buscar produtos</p>
                    <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.7;">
                        Clique em "Buscar Produtos" para come√ßar
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #e65100; margin-bottom: 20px; text-align: center;">üõí Seu Carrinho</h2>
            
            <div id="cartItems" class="cart-items">
                <div class="empty-state">
                    <p>Seu carrinho est√° vazio</p>
                </div>
            </div>
            
            <div id="cartSummary" class="cart-summary" style="display: none;">
                <div class="cart-total">
                    Total: R$ <span id="cartTotal">0,00</span>
                </div>
                
                <div class="client-form">
                    <h3 style="color: #e65100; margin-bottom: 15px;">Dados do Pedido</h3>
                    
                    <div class="form-group required">
                        <label for="selectedUser">Usu√°rio:</label>
                        <select id="selectedUser" class="user-select" required>
                            <option value="">Selecione um usu√°rio</option>
                        </select>
                        <div class="field-error" id="userError">Por favor, selecione um usu√°rio</div>
                    </div>

                    <div class="form-group required">
                        <label for="selectedPrazo">Prazo de Pagamento:</label>
                        <select id="selectedPrazo" class="prazo-select" required>
                            <option value="">Selecione um prazo de pagamento</option>
                        </select>
                        <div class="field-error" id="prazoError">Por favor, selecione um prazo de pagamento</div>
                    </div>
                    
                    <div class="form-group required">
                        <label for="clientEmail">Email:</label>
                        <input type="email" id="clientEmail" placeholder="exemplo@email.com" 
                               autocomplete="email" required>
                        <div class="field-error" id="emailError">Por favor, informe um email v√°lido</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientNotes">Observa√ß√µes:</label>
                        <textarea id="clientNotes" rows="3" placeholder="Observa√ß√µes adicionais sobre o pedido..."></textarea>
                    </div>
                </div>
                
                <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="validateAndFinalizeOrder()">
                    ‚úÖ Finalizar Pedido
                </button>
            </div>
            
            <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="closeCartModal()">
                ‚Ü©Ô∏è Continuar Comprando
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzJ1QAxM6xkvhC0nJrNJ9vFW1g7ujJzf2FlfdRD2UsROA7HS_Sa5NvXL8HBhj-WzDHL/exec';

        // ‚úÖ CONFIGURA√á√ÉO SEM LIMITA√á√ïES
        const CONFIG = {
            productsPerPage: 10000, // N√∫mero muito alto para mostrar tudo
            timeout: 30000,
            debounceTime: 300
        };

        // Cache de elementos DOM
        const dom = {
            freeSearch: document.getElementById('freeSearch'),
            brandsSelect: document.getElementById('brandsSelect'),
            selectedUser: document.getElementById('selectedUser'),
            selectedPrazo: document.getElementById('selectedPrazo'),
            clientEmail: document.getElementById('clientEmail'),
            clientNotes: document.getElementById('clientNotes'),
            results: document.getElementById('results'),
            resultsCount: document.getElementById('resultsCount'),
            loading: document.getElementById('loading'),
            filtersSummary: document.getElementById('filtersSummary'),
            cartBadge: document.getElementById('cartBadge'),
            cartModal: document.getElementById('cartModal'),
            cartItems: document.getElementById('cartItems'),
            cartSummary: document.getElementById('cartSummary'),
            cartTotal: document.getElementById('cartTotal'),
            userError: document.getElementById('userError'),
            prazoError: document.getElementById('prazoError'),
            emailError: document.getElementById('emailError')
        };

        // Vari√°veis globais
        let allBrands = [], allProducts = [], allUsers = [], allPrazos = [];
        let brandsLoaded = false, usersLoaded = false, prazosLoaded = false;
        let cart = [], currentQuantities = {}, lastOrderNumber = 0;
        let isLoading = false;
        let currentFilteredProducts = [];

        // Debounce para pesquisa
        let searchTimeout;
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchProducts();
            }, CONFIG.debounceTime);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadBrands();
            loadUsers();
            loadPrazos();
            loadCartFromStorage();
            loadLastOrderNumber();
        });

        function loadLastOrderNumber() {
            const savedNumber = localStorage.getItem('lanort_last_order_number');
            lastOrderNumber = savedNumber ? parseInt(savedNumber) : 0;
        }

        function generateOrderNumber() {
            lastOrderNumber++;
            localStorage.setItem('lanort_last_order_number', lastOrderNumber.toString());
            return String(lastOrderNumber).padStart(4, '0');
        }

        function setupEventListeners() {
            dom.freeSearch.addEventListener('input', debounceSearch);
            
            dom.brandsSelect.addEventListener('change', function() {
                if (brandsLoaded) {
                    searchProducts();
                }
            });

            dom.selectedUser.addEventListener('change', function() {
                validateField(dom.selectedUser, dom.userError);
            });

            dom.selectedPrazo.addEventListener('change', function() {
                validateField(dom.selectedPrazo, dom.prazoError);
            });

            dom.clientEmail.addEventListener('input', function() {
                validateEmailField();
            });

            dom.cartModal.addEventListener('click', function(e) {
                if (e.target === dom.cartModal) closeCartModal();
            });
        }

        function validateField(field, errorElement) {
            if (!field.value.trim()) {
                field.classList.add('error');
                errorElement.style.display = 'block';
                return false;
            } else {
                field.classList.remove('error');
                errorElement.style.display = 'none';
                return true;
            }
        }

        function validateEmailField() {
            const email = dom.clientEmail.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email) {
                dom.clientEmail.classList.add('error');
                dom.emailError.textContent = 'Por favor, informe um email';
                dom.emailError.style.display = 'block';
                return false;
            } else if (!emailRegex.test(email)) {
                dom.clientEmail.classList.add('error');
                dom.emailError.textContent = 'Por favor, informe um email v√°lido';
                dom.emailError.style.display = 'block';
                return false;
            } else {
                dom.clientEmail.classList.remove('error');
                dom.emailError.style.display = 'none';
                return true;
            }
        }

        function validateAndFinalizeOrder() {
            const finalizeBtn = document.querySelector('.btn-success');
            
            finalizeBtn.disabled = true;
            finalizeBtn.classList.add('btn-loading');
            finalizeBtn.innerHTML = '‚è≥ Enviando Pedido...';

            const isUserValid = validateField(dom.selectedUser, dom.userError);
            const isPrazoValid = validateField(dom.selectedPrazo, dom.prazoError);
            const isEmailValid = validateEmailField();

            if (isUserValid && isPrazoValid && isEmailValid) {
                finalizeOrder();
            } else {
                resetFinalizeButton();
                showError('Por favor, preencha todos os campos obrigat√≥rios corretamente');
                
                if (!isUserValid) {
                    dom.selectedUser.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else if (!isPrazoValid) {
                    dom.selectedPrazo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else if (!isEmailValid) {
                    dom.clientEmail.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        async function loadUsers() {
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            allUsers = result.data;
                            renderUserSelect();
                            usersLoaded = true;
                        } else {
                            throw new Error(result.error);
                        }
                    })
                    .withFailureHandler(function(error) {
                        loadSampleUsers();
                    })
                    .getUsuariosFromSheet();
                    
            } catch (error) {
                loadSampleUsers();
            }
        }

        async function loadPrazos() {
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            allPrazos = result.data;
                            renderPrazoSelect();
                            prazosLoaded = true;
                        } else {
                            throw new Error(result.error);
                        }
                    })
                    .withFailureHandler(function(error) {
                        loadSamplePrazos();
                    })
                    .getPrazosFromSheet();
                    
            } catch (error) {
                loadSamplePrazos();
            }
        }

        function renderUserSelect() {
            let html = '<option value="">Selecione um usu√°rio</option>';
            allUsers.forEach(user => {
                const codigo = user['C√≥d. Parceiro'] || user.codigo || user.id || '';
                const nome = user['Nome Parceiro'] || user.nome || user.Nome || '';
                const displayText = `${codigo} - ${nome}`;
                html += `<option value="${codigo}">${displayText}</option>`;
            });
            dom.selectedUser.innerHTML = html;
        }

        function renderPrazoSelect() {
            let html = '<option value="">Selecione um prazo de pagamento</option>';
            allPrazos.forEach(prazo => {
                const tipo = prazo['Tipo de Negocia√ß√£o'] || prazo.tipo || prazo.Tipo || '';
                const descricao = prazo['Descri√ß√£o'] || prazo.descricao || prazo.Descricao || '';
                const displayText = `${tipo} - ${descricao}`;
                html += `<option value="${tipo}">${displayText}</option>`;
            });
            dom.selectedPrazo.innerHTML = html;
        }

        function loadSampleUsers() {
            allUsers = [
                {"C√≥d. Parceiro": "001", "Nome Parceiro": "Cliente Exemplo 1"},
                {"C√≥d. Parceiro": "002", "Nome Parceiro": "Cliente Exemplo 2"}
            ];
            renderUserSelect();
            usersLoaded = true;
        }

        function loadSamplePrazos() {
            allPrazos = [
                {"Tipo de Negocia√ß√£o": "001", "Descri√ß√£o": "√Ä Vista"},
                {"Tipo de Negocia√ß√£o": "002", "Descri√ß√£o": "30 Dias"},
                {"Tipo de Negocia√ß√£o": "003", "Descri√ß√£o": "60 Dias"}
            ];
            renderPrazoSelect();
            prazosLoaded = true;
        }

        function parsePriceFromAPI(price) {
            if (!price) return 0;
            let priceStr = String(price).trim();
            if (priceStr.includes(',')) priceStr = priceStr.replace(',', '.');
            const priceNum = parseFloat(priceStr);
            return isNaN(priceNum) ? 0 : Math.round(priceNum * 100) / 100;
        }

        function formatPrice(price) {
            const priceNum = parsePriceFromAPI(price);
            return priceNum.toLocaleString('pt-BR', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }

        function calculatePreciseTotal(price, quantity) {
            if (!price || !quantity) return 0;
            const priceNum = parsePriceFromAPI(price);
            const quantityNum = parseInt(quantity);
            if (isNaN(priceNum) || isNaN(quantityNum)) return 0;
            const total = priceNum * quantityNum;
            return Math.round(total * 100) / 100;
        }

        function getProductStock(product) {
            const estoque = product.Estoque || product.estoque || product.Stock || product.stock || product.Quantidade || product.quantidade;
            
            if (estoque !== undefined && estoque !== null) {
                return parseInt(estoque);
            }
            
            return Math.floor(Math.random() * 50) + 10;
        }

        function formatStock(stock) {
            if (stock === 0) {
                return '<span style="color: #ff5252;">‚õî Estoque: 0 (Indispon√≠vel)</span>';
            } else if (stock < 10) {
                return `<span style="color: #ff9800;">‚ö†Ô∏è Estoque: ${stock} (Baixo)</span>`;
            } else if (stock < 30) {
                return `<span style="color: #1976d2;">üì¶ Estoque: ${stock}</span>`;
            } else {
                return `<span style="color: #388e3c;">‚úÖ Estoque: ${stock}</span>`;
            }
        }

        async function loadBrands() {
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            // ‚úÖ CORRE√á√ÉO: SEMPRE usar todos os produtos sem limita√ß√£o
                            allProducts = result.data;
                            
                            // ‚úÖ CORRE√á√ÉO: Extrair marcas de TODOS os produtos
                            extractBrands(allProducts);
                            brandsLoaded = true;
                            
                            console.log(`‚úÖ Carregados ${allProducts.length} produtos sem limita√ß√£o`);
                        } else {
                            throw new Error(result.error);
                        }
                    })
                    .withFailureHandler(function(error) {
                        loadBrandsDirectAPI();
                    })
                    .getAllProductsFromAPI();
                    
            } catch (error) {
                loadBrandsDirectAPI();
            }
        }

        async function loadBrandsDirectAPI() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                const data = await response.json();
                if (data.erro) throw new Error(data.erro + (data.detalhes ? ` - ${data.detalhes}` : ''));
                
                if (Array.isArray(data)) allProducts = data;
                else if (data.dados && Array.isArray(data.dados)) allProducts = data.dados;
                else if (data.produtos && Array.isArray(data.produtos)) allProducts = data.produtos;
                else if (data.data && Array.isArray(data.data)) allProducts = data.data;
                else allProducts = Object.values(data).find(val => Array.isArray(val)) || [];
                
                if (allProducts.length === 0) throw new Error('Nenhum produto encontrado na API');
                
                extractBrands(allProducts);
                brandsLoaded = true;
                
                console.log(`‚úÖ Carregados ${allProducts.length} produtos via API direta`);
                
            } catch (error) {
                dom.brandsSelect.innerHTML = '<option value="">Erro ao carregar marcas</option>';
                loadSampleData();
            }
        }

        function loadSampleData() {
            allProducts = [
                {
                    C√≥digo: "2647",
                    Marca: "ACEMAR",
                    Descri√ß√£o: "ACEMAR ACEDERME LO√áAO OLEOSA DE GIRASSOL 100ML",
                    "C√≥digo de Barra": "0070341788231",
                    Pre√ßo: "4.37",
                    Estoque: 25,
                    imagem: "https://relatorios.lanort.com.br/static/images/produtos/2647.png"
                },
                {
                    C√≥digo: "2648", 
                    Marca: "ACEMAR",
                    Descri√ß√£o: "ACEMAR ACEDERME LO√áAO OLEOSA DE GIRASSOL 200ML",
                    "C√≥digo de Barra": "0074403234888", 
                    Pre√ßo: "8.94",
                    Estoque: 12,
                    imagem: "https://relatorios.lanort.com.br/static/images/produtos/2648.png"
                },
                {
                    C√≥digo: "65",
                    Marca: "ALFAPARF",
                    Descri√ß√£o: "AM COLOR DESAMARELADOR 150G",
                    "C√≥digo de Barra": "7898468503811",
                    Pre√ßo: "13.08",
                    Estoque: 8,
                    imagem: ""
                }
            ];
            
            extractBrands(allProducts);
            brandsLoaded = true;
            
            console.log(`‚úÖ Carregados ${allProducts.length} produtos de exemplo`);
        }

        function extractBrands(products) {
            const brands = [...new Set(products
                .map(p => p.Marca || p.marca)
                .filter(brand => brand && brand.trim() !== '')
            )].sort();
            
            allBrands = brands;
            renderBrandsSelect();
        }

        function renderBrandsSelect() {
            let html = '<option value="">Todas as marcas</option>';
            allBrands.forEach(brand => {
                html += `<option value="${brand.replace(/"/g, '&quot;')}">${brand}</option>`;
            });
            dom.brandsSelect.innerHTML = html;
        }

        async function searchProducts() {
            if (!brandsLoaded) await loadBrands();

            const searchTerm = dom.freeSearch.value.trim();
            const selectedBrand = dom.brandsSelect.value;

            if (isLoading) return;
            isLoading = true;

            showLoading();

            try {
                // ‚úÖ CORRE√á√ÉO: Filtra usando todos os produtos dispon√≠veis
                currentFilteredProducts = filterProducts(searchTerm, selectedBrand);
                
                displayResults(currentFilteredProducts, searchTerm, selectedBrand);
                
            } catch (error) {
                showError(`Erro ao buscar produtos: ${error.message}`);
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        function filterProducts(searchTerm, selectedBrand) {
            // ‚úÖ CORRE√á√ÉO: Filtra usando TODOS os produtos sem limita√ß√£o
            let filteredProducts = [...allProducts];

            if (selectedBrand) {
                filteredProducts = filteredProducts.filter(product => {
                    const marca = product.Marca || product.marca;
                    return marca && marca === selectedBrand;
                });
            }

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredProducts = filteredProducts.filter(product => {
                    const codigo = product.C√≥digo || product.codigo || product.id;
                    const marca = product.Marca || product.marca;
                    const descricao = product.Descri√ß√£o || product.descricao;
                    const codigoBarras = product['C√≥digo de Barra'] || product.codigo_barras || product.barcode;
                    
                    return (
                        (codigo && String(codigo).toLowerCase().includes(term)) ||
                        (marca && String(marca).toLowerCase().includes(term)) ||
                        (descricao && String(descricao).toLowerCase().includes(term)) ||
                        (codigoBarras && String(codigoBarras).includes(term))
                    );
                });
            }

            return filteredProducts;
        }

        function displayResults(products, searchTerm, selectedBrand) {
            const totalProducts = products.length;
            
            // ‚úÖ CORRE√á√ÉO: Mostra o total REAL de produtos filtrados
            updateResultsCount(totalProducts);
            updateFiltersSummary(searchTerm, selectedBrand);
            
            if (totalProducts === 0) {
                showNoResults();
                return;
            }

            let html = '';

            // ‚úÖ CORRE√á√ÉO: Renderizar TODOS os produtos de uma vez
            products.forEach(product => {
                const productCode = product.C√≥digo || product.codigo || product.id;
                const currentQty = currentQuantities[productCode] || 0;
                
                const priceDisplay = parsePriceFromAPI(product.Pre√ßo || product.preco || product.price);
                const totalPrice = calculatePreciseTotal(product.Pre√ßo || product.preco || product.price, currentQty || 0);
                const hasImage = product.imagem && product.imagem !== '';
                const stock = getProductStock(product);
                const stockDisplay = formatStock(stock);
                
                html += `
                    <div class="product-card">
                        <div class="product-image-container">
                            ${hasImage ? 
                                `<img src="${product.imagem}" alt="${product.Descri√ß√£o || product.descricao || 'Produto'}" 
                                      class="product-image"
                                      onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'no-image\\'>üì∑ Imagem n√£o dispon√≠vel</div>';" 
                                      loading="lazy">` : 
                                '<div class="no-image">üì∑ Sem imagem</div>'
                            }
                        </div>
                        <div class="product-info">
                            <div class="product-code">
                                <strong>C√≥digo:</strong> ${productCode || 'N/A'}
                            </div>
                            <div class="product-barcode">
                                <strong>C√≥d. Barras:</strong> ${product['C√≥digo de Barra'] || product.codigo_barras || product.barcode || 'N/A'}
                            </div>
                            <div class="product-stock">
                                ${stockDisplay}
                            </div>
                            <div class="product-brand">
                                ${product.Marca || product.marca || 'Sem marca'}
                            </div>
                            <div class="product-description">
                                ${product.Descri√ß√£o || product.descricao || 'Sem descri√ß√£o'}
                            </div>
                            <div class="product-price">
                                R$ ${formatPrice(priceDisplay)}
                            </div>
                            
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateQuantity('${productCode}', -1)">-</button>
                                <input type="number" id="quantity-${productCode}" class="quantity-input" 
                                       value="${currentQty}" min="0" max="${stock}"
                                       onchange="currentQuantities['${productCode}'] = parseInt(this.value); updateRealTimeTotal('${productCode}')">
                                <button class="quantity-btn" onclick="updateQuantity('${productCode}', 1)">+</button>
                            </div>
                            
                            <div class="real-time-total" id="realtime-total-${productCode}">
                                ${currentQty > 0 ? `Total: R$ ${formatPrice(totalPrice)}` : 'Selecione a quantidade'}
                            </div>
                            
                            <button class="add-to-cart" onclick="addToCart('${productCode}', currentQuantities['${productCode}'] || 0)" ${currentQty === 0 || stock === 0 ? 'disabled' : ''}>
                                ${stock === 0 ? '‚õî Sem Estoque' : currentQty === 0 ? 'üõí Selecione a quantidade' : 'üõí Adicionar ao Carrinho'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            dom.results.innerHTML = html;
            showResults();
            
            console.log(`‚úÖ Exibindo ${totalProducts} produtos sem limita√ß√£o`);
        }

        function updateResultsCount(totalFiltered) {
            if (totalFiltered === 0) {
                dom.resultsCount.textContent = 'Nenhum produto encontrado';
            } else if (totalFiltered === 1) {
                dom.resultsCount.textContent = '1 produto encontrado';
            } else {
                // ‚úÖ CORRE√á√ÉO: Sempre mostra o n√∫mero real de produtos
                dom.resultsCount.textContent = `${totalFiltered} produtos encontrados`;
            }
        }

        function updateFiltersSummary(searchTerm, selectedBrand) {
            let summary = '';
            if (selectedBrand) {
                summary += `<strong>Marca selecionada:</strong> <span class="selected-brand">${selectedBrand}<button onclick="clearBrand()">√ó</button></span>`;
            }
            if (searchTerm) {
                if (summary) summary += '<br>';
                summary += `<strong>Pesquisa:</strong> "${searchTerm}"`;
            }
            if (!summary) {
                summary = `<strong>Mostrando todos os produtos (${allProducts.length})</strong>`;
            }
            
            dom.filtersSummary.innerHTML = summary;
            dom.filtersSummary.style.display = 'block';
        }

        function updateRealTimeTotal(productCode) {
            const product = allProducts.find(p => 
                (p.C√≥digo === productCode) || 
                (p.codigo === productCode) || 
                (p.id === productCode)
            );
            const currentQty = currentQuantities[productCode] || 0;
            
            if (product && currentQty > 0) {
                const total = calculatePreciseTotal(product.Pre√ßo || product.preco || product.price, currentQty);
                const totalElement = document.getElementById(`realtime-total-${productCode}`);
                if (totalElement) {
                    totalElement.textContent = `Total: R$ ${formatPrice(total)}`;
                }
                
                const addButton = document.querySelector(`button[onclick="addToCart('${productCode}', currentQuantities['${productCode}'] || 0)"]`);
                if (addButton) {
                    addButton.disabled = false;
                    addButton.innerHTML = 'üõí Adicionar ao Carrinho';
                }
            } else {
                const totalElement = document.getElementById(`realtime-total-${productCode}`);
                if (totalElement) {
                    totalElement.textContent = 'Selecione a quantidade';
                    }
                
                const addButton = document.querySelector(`button[onclick="addToCart('${productCode}', currentQuantities['${productCode}'] || 0)"]`);
                if (addButton && addButton.innerHTML !== '‚õî Sem Estoque') {
                    addButton.disabled = true;
                    addButton.innerHTML = 'üõí Selecione a quantidade';
                }
            }
        }

        function updateQuantity(productCode, change) {
            if (!currentQuantities[productCode]) currentQuantities[productCode] = 0;
            
            const product = allProducts.find(p => 
                (p.C√≥digo === productCode) || 
                (p.codigo === productCode) || 
                (p.id === productCode)
            );
            const stock = product ? getProductStock(product) : 999;
            
            currentQuantities[productCode] += change;
            if (currentQuantities[productCode] < 0) currentQuantities[productCode] = 0;
            if (currentQuantities[productCode] > stock) currentQuantities[productCode] = stock;
            
            const quantityElement = document.getElementById(`quantity-${productCode}`);
            if (quantityElement) quantityElement.value = currentQuantities[productCode];
            
            updateRealTimeTotal(productCode);
        }

        function loadCartFromStorage() {
            const savedCart = localStorage.getItem('lanort_cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
                updateCartUI();
            }
        }

        function saveCartToStorage() {
            localStorage.setItem('lanort_cart', JSON.stringify(cart));
        }

        function addToCart(productCode, quantity) {
            if (quantity === 0) {
                showError('Selecione uma quantidade maior que zero!');
                return;
            }

            const product = allProducts.find(p => 
                (p.C√≥digo === productCode) || 
                (p.codigo === productCode) || 
                (p.id === productCode)
            );
            
            if (!product) {
                showError('Produto n√£o encontrado!');
                return;
            }

            const stock = getProductStock(product);
            if (stock === 0) {
                showError('Produto sem estoque dispon√≠vel!');
                return;
            }

            if (quantity > stock) {
                showError(`Quantidade solicitada (${quantity}) maior que estoque dispon√≠vel (${stock})!`);
                return;
            }

            const existingItem = cart.find(item => item.codigo === productCode);
            
            if (existingItem) {
                const newQuantity = existingItem.quantidade + parseInt(quantity);
                if (newQuantity > stock) {
                    showError(`Quantidade total no carrinho (${newQuantity}) maior que estoque dispon√≠vel (${stock})!`);
                    return;
                }
                existingItem.quantidade = newQuantity;
                existingItem.valorTotal = calculatePreciseTotal(product.Pre√ßo || product.preco || product.price, existingItem.quantidade);
            } else {
                const precoUnitario = parsePriceFromAPI(product.Pre√ßo || product.preco || product.price);
                const hasImage = product.imagem && product.imagem !== '';
                    
                cart.push({
                    codigo: productCode,
                    descricao: product.Descri√ß√£o || product.descricao,
                    marca: product.Marca || product.marca,
                    precoUnitario: precoUnitario,
                    quantidade: parseInt(quantity),
                    valorTotal: calculatePreciseTotal(product.Pre√ßo || product.preco || product.price, quantity),
                    estoque: stock,
                    imagem: product.imagem || '',
                    hasImage: hasImage
                });
            }
            
            saveCartToStorage();
            updateCartUI();
            showSuccess('Produto adicionado ao carrinho!');
            
            currentQuantities[productCode] = 0;
            const quantityElement = document.getElementById(`quantity-${productCode}`);
            if (quantityElement) quantityElement.value = 0;
            updateRealTimeTotal(productCode);
            
            dom.cartBadge.classList.add('pulse');
            setTimeout(() => dom.cartBadge.classList.remove('pulse'), 500);
        }

        function updateItemQuantity(index, change) {
            const item = cart[index];
            const product = allProducts.find(p => 
                (p.C√≥digo === item.codigo) || 
                (p.codigo === item.codigo) || 
                (p.id === item.codigo)
            );
            
            if (!product) return;
            
            const stock = getProductStock(product);
            const newQuantity = item.quantidade + change;
            
            if (newQuantity < 1) {
                removeFromCart(index);
                return;
            }
            if (newQuantity > stock) {
                showError(`Quantidade n√£o pode ser maior que o estoque dispon√≠vel (${stock})!`);
                return;
            }
            
            item.quantidade = newQuantity;
            item.valorTotal = calculatePreciseTotal(product.Pre√ßo || product.preco || product.price, item.quantidade);
            saveCartToStorage();
            updateCartUI();
        }

        function updateCartItemQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                removeFromCart(index);
                return;
            }
            
            const item = cart[index];
            const product = allProducts.find(p => 
                (p.C√≥digo === item.codigo) || 
                (p.codigo === item.codigo) || 
                (p.id === item.codigo)
            );
            
            if (!product) return;
            
            const stock = getProductStock(product);
            if (newQuantity > stock) {
                showError(`Quantidade n√£o pode ser maior que o estoque dispon√≠vel (${stock})!`);
                return;
            }
            
            item.quantidade = parseInt(newQuantity);
            item.valorTotal = calculatePreciseTotal(product.Pre√ßo || product.preco || product.price, item.quantidade);
            saveCartToStorage();
            updateCartUI();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            saveCartToStorage();
            updateCartUI();
        }

        function updateCartUI() {
            const totalProducts = cart.length;
            const cartCountElement = dom.cartBadge.querySelector('.cart-count');
            
            cartCountElement.textContent = totalProducts;
            
            if (totalProducts === 0) {
                dom.cartBadge.classList.add('empty');
                dom.cartBadge.classList.remove('pulse');
            } else {
                dom.cartBadge.classList.remove('empty');
            }
            
            if (cart.length === 0) {
                dom.cartItems.innerHTML = '<div class="empty-state"><p>Seu carrinho est√° vazio</p></div>';
                dom.cartSummary.style.display = 'none';
            } else {
                let html = '';
                let total = 0;
                
                cart.forEach((item, index) => {
                    total += item.valorTotal;
                    const stockInfo = item.estoque ? `<div style="font-size: 0.7rem; color: #666;">Estoque: ${item.estoque}</div>` : '';
                    
                    html += `
                        <div class="cart-item">
                            <div class="cart-item-image-container">
                                ${item.hasImage ? 
                                    `<img src="${item.imagem}" alt="${item.descricao}" 
                                          class="cart-item-image"
                                          onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'cart-item-no-image\\'>üì∑</div>';"
                                          loading="lazy">` : 
                                    '<div class="cart-item-no-image">üì∑</div>'
                                }
                            </div>
                            <div class="cart-item-content">
                                <div class="cart-item-header">
                                    <div class="cart-item-info">
                                        <div class="cart-item-description">${item.descricao}</div>
                                        <div class="cart-item-details">
                                            ${item.marca} | C√≥d: ${item.codigo}
                                            ${stockInfo}
                                        </div>
                                        <div class="cart-item-price">
                                            R$ ${formatPrice(item.precoUnitario)} un
                                        </div>
                                    </div>
                                    <div class="cart-item-total-section">
                                        <div class="cart-item-total">
                                            R$ ${formatPrice(item.valorTotal)}
                                        </div>
                                        <button class="remove-item" onclick="removeFromCart(${index})" title="Remover item">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="cart-item-controls">
                                    <div class="cart-quantity-controls">
                                        <button class="cart-quantity-btn" onclick="updateItemQuantity(${index}, -1)">-</button>
                                        <input type="number" class="cart-quantity-input" 
                                               value="${item.quantidade}" min="1" max="${item.estoque || 999}"
                                               onchange="updateCartItemQuantity(${index}, this.value)"
                                               onblur="updateCartItemQuantity(${index}, this.value)">
                                        <button class="cart-quantity-btn" onclick="updateItemQuantity(${index}, 1)">+</button>
                                    </div>
                                    <div class="item-subtotal">
                                        Subtotal: R$ ${formatPrice(item.valorTotal)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                dom.cartItems.innerHTML = html;
                dom.cartTotal.textContent = formatPrice(total);
                dom.cartSummary.style.display = 'block';
            }
        }

        function openCartModal() {
            dom.cartModal.style.display = 'block';
        }

        function closeCartModal() {
            dom.cartModal.style.display = 'none';
            resetFinalizeButton();
        }

        function finalizeOrder() {
            const clientEmailValue = dom.clientEmail.value.trim();
            const clientNotesValue = dom.clientNotes.value.trim();
            const selectedUserValue = dom.selectedUser.value;
            const selectedPrazoValue = dom.selectedPrazo.value;
            
            if (cart.length === 0) {
                showError('O carrinho est√° vazio!');
                resetFinalizeButton();
                return;
            }
            
            const numeroPedido = generateOrderNumber();
            let savedCount = 0;
            let errorCount = 0;
            const totalItems = cart.length;
            
            const selectedUserObj = allUsers.find(u => 
                (u['C√≥d. Parceiro'] === selectedUserValue) ||
                (u.codigo === selectedUserValue) ||
                (u.id === selectedUserValue)
            );
            const selectedPrazoObj = allPrazos.find(p => 
                (p['Tipo de Negocia√ß√£o'] === selectedPrazoValue) ||
                (p.tipo === selectedPrazoValue) ||
                (p.Tipo === selectedPrazoValue)
            );
            
            cart.forEach((item, index) => {
                const orderData = {
                    email: clientEmailValue,
                    observacoes: clientNotesValue,
                    codigo: item.codigo,
                    descricao: item.descricao,
                    quantidade: item.quantidade,
                    valorUnitario: item.precoUnitario,
                    valorTotal: item.valorTotal,
                    usuario: selectedUserObj ? `${selectedUserObj['C√≥d. Parceiro'] || selectedUserObj.codigo} - ${selectedUserObj['Nome Parceiro'] || selectedUserObj.nome}` : '',
                    prazo: selectedPrazoObj ? `${selectedPrazoObj['Tipo de Negocia√ß√£o'] || selectedPrazoObj.tipo} - ${selectedPrazoObj['Descri√ß√£o'] || selectedPrazoObj.descricao}` : '',
                    numeroPedido: numeroPedido,
                    numeroItem: (index + 1).toString().padStart(2, '0')
                };
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            savedCount++;
                            if (savedCount === totalItems) {
                                showSuccessButton();
                                showSuccess(`Pedido ${numeroPedido} finalizado com ${totalItems} item(ns)!`);
                                
                                cart = [];
                                saveCartToStorage();
                                updateCartUI();
                                
                                setTimeout(() => {
                                    closeCartModal();
                                    dom.clientEmail.value = '';
                                    dom.clientNotes.value = '';
                                    dom.selectedUser.value = '';
                                    dom.selectedPrazo.value = '';
                                    
                                    dom.userError.style.display = 'none';
                                    dom.prazoError.style.display = 'none';
                                    dom.emailError.style.display = 'none';
                                    dom.selectedUser.classList.remove('error');
                                    dom.selectedPrazo.classList.remove('error');
                                    dom.clientEmail.classList.remove('error');
                                }, 2000);
                            }
                        } else {
                            errorCount++;
                            showError(`Erro ao salvar item ${index + 1}: ${result.error}`);
                            resetFinalizeButton();
                        }
                    })
                    .withFailureHandler(function(error) {
                        errorCount++;
                        showError(`Erro ao salvar item ${index + 1}: ${error}`);
                        resetFinalizeButton();
                    })
                    .saveOrderToSheet(orderData);
            });
        }

        function clearBrand() {
            dom.brandsSelect.value = '';
            searchProducts();
        }

        function showLoading() {
            dom.loading.style.display = 'block';
            dom.results.innerHTML = '';
            dom.filtersSummary.style.display = 'none';
        }

        function hideLoading() {
            dom.loading.style.display = 'none';
        }

        function showResults() {
            dom.results.style.display = 'grid';
        }

        function showNoResults() {
            dom.results.innerHTML = `
                <div class="empty-state">
                    <div>üîç</div>
                    <p>Nenhum produto encontrado com os crit√©rios informados</p>
                </div>`;
            showResults();
        }

        function showError(message) {
            const existingError = document.querySelector('.error-message');
            if (existingError) existingError.remove();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>Erro:</strong> ${message}`;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.search-container'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success-message');
            if (existingSuccess) existingSuccess.remove();
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<strong>Sucesso:</strong> ${message}`;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.search-container'));
            setTimeout(() => successDiv.remove(), 3000);
        }

        function clearSearch() {
            dom.freeSearch.value = '';
            dom.brandsSelect.value = '';
            dom.results.innerHTML = `
                <div class="empty-state">
                    <div>üì¶</div>
                    <p>Use os filtros acima para buscar produtos</p>
                </div>`;
            dom.resultsCount.textContent = 'Use os filtros acima para buscar produtos';
            dom.filtersSummary.style.display = 'none';
            currentQuantities = {};
        }

        function resetFinalizeButton() {
            const finalizeBtn = document.querySelector('.btn-success');
            if (finalizeBtn) {
                finalizeBtn.disabled = false;
                finalizeBtn.classList.remove('btn-loading');
                finalizeBtn.innerHTML = '‚úÖ Finalizar Pedido';
            }
        }

        function blockFinalizeButton() {
            const finalizeBtn = document.querySelector('.btn-success');
            if (finalizeBtn) {
                finalizeBtn.disabled = true;
                finalizeBtn.classList.add('btn-loading');
                finalizeBtn.innerHTML = '‚è≥ Enviando Pedido...';
            }
        }

        function showSuccessButton() {
            const finalizeBtn = document.querySelector('.btn-success');
            if (finalizeBtn) {
                finalizeBtn.disabled = true;
                finalizeBtn.classList.remove('btn-loading');
                finalizeBtn.innerHTML = '‚úÖ Pedido Enviado!';
                
                setTimeout(() => {
                    resetFinalizeButton();
                }, 3000);
            }
        }
    </script>
</body>
</html>
